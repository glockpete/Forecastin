# Nginx configuration for testing anti-crawler and rate limiting behavior
# Used in docker-compose.dev.yml to simulate production rate limits

events {
    worker_connections 1024;
}

http {
    # Define rate limiting zones
    # 10m = 10MB memory for tracking, ~160k IP addresses
    # rate=5r/s = 5 requests per second per IP
    limit_req_zone $binary_remote_addr zone=rsshub_zone:10m rate=5r/s;

    # Log rate limit violations
    limit_req_log_level warn;
    limit_req_status 429;

    # Upstream RSSHub service
    upstream rsshub_backend {
        server rsshub:1200;
    }

    server {
        listen 80;
        server_name localhost;

        # Access and error logs
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log warn;

        # Proxy to RSSHub with rate limiting
        location / {
            # Apply rate limit
            # burst=10 allows bursts of up to 10 requests
            # nodelay processes burst requests immediately (don't queue)
            limit_req zone=rsshub_zone burst=10 nodelay;

            # Proxy headers
            proxy_pass http://rsshub_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Custom header to identify rate-limited responses
            add_header X-RateLimit-Limit "5" always;
            add_header X-RateLimit-Remaining "0" always;

            # Timeouts
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Health check endpoint (no rate limit)
        location /health {
            limit_req off;
            access_log off;
            return 200 "OK\n";
        }

        # Simulate Cloudflare-like challenge for specific paths
        location /protected/ {
            # Block requests without proper User-Agent
            if ($http_user_agent ~* (curl|wget|python-requests)) {
                return 403 "Forbidden - Bot detected\n";
            }

            # Add Cloudflare-like headers
            add_header CF-RAY "test-ray-id" always;
            add_header Server "cloudflare" always;

            proxy_pass http://rsshub_backend;
        }
    }
}
