{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Forecastin WebSocket Messages",
  "description": "WebSocket message schemas for real-time geospatial updates",
  "version": "1.0.0",
  "definitions": {
    "BoundingBox": {
      "type": "object",
      "required": [
        "minLat",
        "maxLat",
        "minLng",
        "maxLng"
      ],
      "properties": {
        "minLat": {
          "type": "number",
          "minimum": -90,
          "maximum": 90
        },
        "maxLat": {
          "type": "number",
          "minimum": -90,
          "maximum": 90
        },
        "minLng": {
          "type": "number",
          "minimum": -180,
          "maximum": 180
        },
        "maxLng": {
          "type": "number",
          "minimum": -180,
          "maximum": 180
        }
      }
    },
    "Position": {
      "type": "array",
      "minItems": 2,
      "maxItems": 3,
      "items": {
        "type": "number"
      }
    },
    "Color": {
      "type": "array",
      "minItems": 4,
      "maxItems": 4,
      "items": {
        "type": "integer",
        "minimum": 0,
        "maximum": 255
      }
    },
    "Geometry": {
      "oneOf": [
        {
          "type": "object",
          "required": [
            "type",
            "coordinates"
          ],
          "properties": {
            "type": {
              "const": "Point"
            },
            "coordinates": {
              "$ref": "#/definitions/Position"
            }
          }
        },
        {
          "type": "object",
          "required": [
            "type",
            "coordinates"
          ],
          "properties": {
            "type": {
              "const": "LineString"
            },
            "coordinates": {
              "type": "array",
              "minItems": 2,
              "items": {
                "$ref": "#/definitions/Position"
              }
            }
          }
        },
        {
          "type": "object",
          "required": [
            "type",
            "coordinates"
          ],
          "properties": {
            "type": {
              "const": "Polygon"
            },
            "coordinates": {
              "type": "array",
              "items": {
                "type": "array",
                "minItems": 4,
                "items": {
                  "$ref": "#/definitions/Position"
                }
              }
            }
          }
        }
      ]
    },
    "LayerDataUpdate": {
      "type": "object",
      "required": [
        "type",
        "payload"
      ],
      "properties": {
        "type": {
          "const": "LAYER_DATA_UPDATE"
        },
        "payload": {
          "type": "object",
          "required": [
            "layer_id",
            "layer_type",
            "layer_data",
            "changed_at"
          ],
          "properties": {
            "layer_id": {
              "type": "string",
              "minLength": 1
            },
            "layer_type": {
              "type": "string",
              "enum": [
                "point",
                "polygon",
                "line",
                "linestring",
                "heatmap",
                "cluster",
                "geojson"
              ]
            },
            "layer_data": {
              "type": "object",
              "required": [
                "type",
                "features"
              ],
              "properties": {
                "type": {
                  "const": "FeatureCollection"
                },
                "features": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": [
                      "type",
                      "geometry"
                    ],
                    "properties": {
                      "type": {
                        "const": "Feature"
                      },
                      "geometry": {
                        "$ref": "#/definitions/Geometry"
                      },
                      "properties": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            },
            "bbox": {
              "$ref": "#/definitions/BoundingBox"
            },
            "changed_at": {
              "type": "number"
            }
          }
        },
        "meta": {
          "type": "object",
          "required": [
            "timestamp"
          ],
          "properties": {
            "timestamp": {
              "type": "number"
            },
            "sequence": {
              "type": "integer",
              "minimum": 0
            },
            "clientId": {
              "type": "string"
            },
            "sessionId": {
              "type": "string"
            }
          }
        }
      }
    },
    "PolygonUpdate": {
      "type": "object",
      "required": [
        "type",
        "payload"
      ],
      "properties": {
        "type": {
          "const": "POLYGON_UPDATE"
        },
        "payload": {
          "type": "object",
          "required": [
            "entityId",
            "geometry",
            "properties",
            "bbox",
            "timestamp"
          ],
          "properties": {
            "entityId": {
              "type": "string",
              "minLength": 1
            },
            "geometry": {
              "$ref": "#/definitions/Geometry"
            },
            "properties": {
              "type": "object",
              "required": [
                "name",
                "entityType",
                "confidence",
                "hierarchyPath"
              ],
              "properties": {
                "name": {
                  "type": "string"
                },
                "entityType": {
                  "type": "string",
                  "enum": [
                    "country",
                    "region",
                    "infrastructure",
                    "zone",
                    "border",
                    "pipeline",
                    "route",
                    "unknown"
                  ]
                },
                "confidence": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                },
                "hierarchyPath": {
                  "type": "string"
                }
              }
            },
            "bbox": {
              "$ref": "#/definitions/BoundingBox"
            },
            "changeReason": {
              "type": "string"
            },
            "timestamp": {
              "type": "string",
              "format": "date-time"
            }
          }
        }
      }
    }
  },
  "oneOf": [
    {
      "$ref": "#/definitions/LayerDataUpdate"
    },
    {
      "$ref": "#/definitions/PolygonUpdate"
    }
  ]
}