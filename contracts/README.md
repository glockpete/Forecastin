# Contracts Directory

This directory contains auto-generated API contract schemas for the Forecastin platform.

## Files

### `openapi.json`
OpenAPI 3.1 schema generated from the FastAPI backend application.

**Generated by:** `scripts/generate_openapi_minimal.py`
**Contains:** REST API endpoint specifications, request/response schemas, authentication schemes

**Usage:**
```bash
make openapi
# or
python3 scripts/generate_openapi_minimal.py
```

### `ws.json`
WebSocket message contract schema generated from Pydantic models.

**Generated by:** `scripts/generate_ws_contract.py`
**Contains:** WebSocket message types, payloads, geometry schemas, enums

**Usage:**
```bash
make ws-contracts
# or
python3 scripts/generate_ws_contract.py
```

## Contract Generation Workflow

### Generate All Contracts
```bash
make contracts
```

This will:
1. Generate `contracts/openapi.json` from FastAPI app
2. Generate `contracts/ws.json` from Pydantic WebSocket schemas
3. Generate `frontend/src/types/contracts.generated.ts` from Python models
4. Verify contract consistency

### Manual Generation

```bash
# 1. Generate OpenAPI schema
python3 scripts/generate_openapi_minimal.py

# 2. Generate WebSocket schema
python3 scripts/generate_ws_contract.py

# 3. Generate TypeScript types
python3 scripts/dev/generate_contracts.py

# 4. Verify (optional)
cd frontend && npm run contracts:check
```

## Contract Drift Detection

The CI/CD pipeline automatically checks for contract drift on all PRs to `main` or `develop`.

**Workflow:** `.github/workflows/contract-drift-check.yml`

**What it checks:**
- Generated contracts match committed versions
- TypeScript types are in sync with Python models
- No validation errors in generated schemas

**If drift is detected:**
```bash
# Regenerate contracts locally
make contracts

# Commit the updated files
git add contracts/ frontend/src/types/contracts.generated.ts
git commit -m "chore: Update generated contracts"
git push
```

## Schema Structure

### OpenAPI Schema (`openapi.json`)

```json
{
  "openapi": "3.1.0",
  "info": {
    "title": "Forecastin Geopolitical Intelligence Platform API",
    "version": "1.0.0"
  },
  "paths": {
    "/api/v3/steep": { ... },
    "/api/v3/scenarios/{path}/analysis": { ... },
    "/ws": { ... }
  },
  "components": {
    "schemas": { ... }
  }
}
```

### WebSocket Schema (`ws.json`)

```json
{
  "version": "1.0.0",
  "generated": "2025-11-08T...",
  "description": "WebSocket message contracts",
  "schemas": {
    "PingMessage": { ... },
    "LayerDataUpdateMessage": { ... },
    "GPUFilterSyncMessage": { ... }
  },
  "enums": {
    "MessageType": { ... },
    "LayerType": { ... }
  }
}
```

## TypeScript Integration

The TypeScript contracts are automatically generated from these schemas and Python models.

**Output:** `frontend/src/types/contracts.generated.ts`

**Usage in Frontend:**
```typescript
import { ScenarioEntity, LayerDataUpdateMessage } from '@/types/contracts.generated';

// Runtime validation with Zod
import { parseContract, EntitySchema } from '@/types/zod/entities';

const entity = parseContract(EntitySchema, rawData, 'myFunction');
```

## Maintenance

### When to Regenerate Contracts

Regenerate contracts whenever you:
- Add or modify FastAPI endpoints
- Change Pydantic model definitions
- Update WebSocket message schemas
- Modify request/response structures

### Verification

After regenerating contracts, always:
1. Run TypeScript type check: `cd frontend && npm run typecheck`
2. Run contract tests: `cd frontend && npm test -- contract_drift.spec.ts`
3. Commit both contract files and generated TypeScript types

## Troubleshooting

### Contract Generation Fails

**Issue:** Missing Python dependencies

**Solution:**
```bash
pip install --break-system-packages pydantic fastapi
```

The OpenAPI generator will fall back to a minimal schema if the full FastAPI app cannot be imported.

### Type Mismatches

**Issue:** TypeScript types don't match Python models

**Solution:**
1. Check type mappings in `scripts/dev/generate_contracts.py`
2. Verify Python model field types are supported
3. Regenerate: `make contracts`

### Contract Drift in CI/CD

**Issue:** CI/CD fails with contract drift

**Solution:**
```bash
make contracts
git add contracts/ frontend/src/types/contracts.generated.ts
git commit -m "chore: Update contracts"
```

## Documentation

- **Phase 2 & 3 Implementation:** `docs/PHASE_2_3_IMPLEMENTATION.md`
- **STEEP Analysis Findings:** `STEEP_ANALYSIS_FINDINGS.md`
- **Contract Drift Tests:** `frontend/tests/contracts/contract_drift.spec.ts`

---

**Auto-generated files - DO NOT EDIT MANUALLY**

These contract files are automatically generated. Any manual changes will be overwritten on the next generation.

To modify contracts, update the source:
- OpenAPI: Update FastAPI endpoints and models
- WebSocket: Update `api/models/websocket_schemas.py`
- TypeScript: Update Python Pydantic models

Then regenerate: `make contracts`
