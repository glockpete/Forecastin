# Docker Compose Override Example - WebSocket Configuration
#
# This file demonstrates how to configure WebSocket settings for Forecastin.
# Copy this file to docker-compose.override.yml and customize as needed.
#
# Usage:
#   cp docker-compose.override.example.yml docker-compose.override.yml
#   # Edit docker-compose.override.yml with your settings
#   docker-compose up -d
#
# Docker Compose automatically merges docker-compose.override.yml with
# docker-compose.yml, allowing you to customize without modifying base config.

version: '3.8'

services:
  # ========================================
  # API Service - WebSocket Configuration
  # ========================================
  api:
    environment:
      # WebSocket Heartbeat Configuration
      # Adjust these to prevent 1006 disconnects
      WS_PING_INTERVAL: "30"        # Send server ping every 30 seconds
      WS_PING_TIMEOUT: "10"         # Wait 10 seconds for pong response

      # CORS and Origin Configuration
      # Add your frontend domains to allowed origins
      ALLOWED_ORIGINS: "http://localhost:3000,http://127.0.0.1:3000,https://app.yourdomain.com"

      # Public URL Configuration
      # For production, set these to your public-facing URLs
      PUBLIC_BASE_URL: "http://localhost:9000"
      WS_PUBLIC_URL: "ws://localhost:9000/ws"

      # Production example:
      # PUBLIC_BASE_URL: "https://api.yourdomain.com"
      # WS_PUBLIC_URL: "wss://api.yourdomain.com/ws"

    # Expose WebSocket port (only needed if accessing directly, not through nginx)
    ports:
      - "9000:9000"

    # Optional: Health check for WebSocket endpoints
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # Nginx Proxy (Optional)
  # ========================================
  # Uncomment to add nginx as WebSocket proxy
  #
  # nginx:
  #   image: nginx:alpine
  #   container_name: forecastin_nginx
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     # Mount nginx WebSocket configuration
  #     - ./ops/nginx/ws.conf:/etc/nginx/conf.d/websocket.conf:ro
  #
  #     # Optional: Custom nginx.conf
  #     # - ./ops/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #
  #     # Optional: SSL certificates for wss://
  #     # - ./ops/nginx/ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - api
  #   networks:
  #     - forecastin_network
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

# ========================================
# Example Nginx Configuration
# ========================================
# If using nginx service above, create ops/nginx/nginx.conf:
#
# user nginx;
# worker_processes auto;
# error_log /var/log/nginx/error.log warn;
# pid /var/run/nginx.pid;
#
# events {
#     worker_connections 1024;
# }
#
# http {
#     include /etc/nginx/mime.types;
#     default_type application/octet-stream;
#
#     log_format main '$remote_addr - $remote_user [$time_local] "$request" '
#                     '$status $body_bytes_sent "$http_referer" '
#                     '"$http_user_agent" "$http_x_forwarded_for"';
#
#     access_log /var/log/nginx/access.log main;
#
#     sendfile on;
#     keepalive_timeout 65;
#
#     # WebSocket support
#     map $http_upgrade $connection_upgrade {
#         default upgrade;
#         '' close;
#     }
#
#     server {
#         listen 80;
#         server_name localhost;
#
#         # Include WebSocket configuration
#         include /etc/nginx/conf.d/websocket.conf;
#
#         # Health check endpoint
#         location /health {
#             proxy_pass http://api:9000/health;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#         }
#
#         # API endpoints
#         location /api/ {
#             proxy_pass http://api:9000/api/;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#         }
#
#         # Frontend (if serving static files)
#         location / {
#             proxy_pass http://frontend:3000;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#         }
#     }
# }

# ========================================
# Environment-Specific Overrides
# ========================================

# Development: Fast heartbeat for testing
# Uncomment for development environment
# services:
#   api:
#     environment:
#       WS_PING_INTERVAL: "5"   # Faster pings for development testing

# Production: SSL/TLS with nginx
# Uncomment for production with SSL
# services:
#   api:
#     environment:
#       PUBLIC_BASE_URL: "https://api.yourdomain.com"
#       WS_PUBLIC_URL: "wss://api.yourdomain.com/ws"
#       ALLOWED_ORIGINS: "https://app.yourdomain.com,https://www.yourdomain.com"
#
#   nginx:
#     image: nginx:alpine
#     ports:
#       - "80:80"
#       - "443:443"
#     volumes:
#       - ./ops/nginx/ws.conf:/etc/nginx/conf.d/websocket.conf:ro
#       - ./ops/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
#       - /etc/letsencrypt:/etc/nginx/ssl:ro  # Let's Encrypt certificates
#     environment:
#       - NGINX_HOST=yourdomain.com
#       - NGINX_PORT=80

# ========================================
# Testing Configuration
# ========================================
# For CI/testing environments with relaxed timeouts
# services:
#   api:
#     environment:
#       WS_PING_INTERVAL: "10"
#       WS_PING_TIMEOUT: "5"
#       ALLOWED_ORIGINS: "http://localhost:3000,http://testrunner:8080"

# ========================================
# Troubleshooting
# ========================================
#
# 1. Test WebSocket connection:
#    docker-compose exec api curl -i http://localhost:9000/health
#
# 2. View WebSocket logs:
#    docker-compose logs -f api | grep WS_
#
# 3. Test with wscat:
#    npm install -g wscat
#    wscat -c ws://localhost:9000/ws/echo
#
# 4. Verify environment variables loaded:
#    docker-compose exec api env | grep WS_
#
# 5. Check network connectivity:
#    docker-compose exec api ping postgres
#    docker-compose exec api ping redis
#
# For detailed diagnostics: checks/ws_server_diagnostics.md
