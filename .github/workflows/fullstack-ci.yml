name: Fullstack CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  POSTGRES_VERSION: '15'
  REDIS_VERSION: '7'

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    services:
      # PostgreSQL with PostGIS for geospatial features
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: forecastin_test
          POSTGRES_INITDB_ARGS: "--encoding=UTF8"
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Redis for caching layer
      redis:
        image: redis:${{ env.REDIS_VERSION }}
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt
          pip install pytest-cov pytest-benchmark

      - name: Setup PostgreSQL extensions
        run: |
          # Install LTREE extension for hierarchical data
          PGPASSWORD=postgres psql -h localhost -U postgres -d forecastin_test -c "CREATE EXTENSION IF NOT EXISTS ltree;"
          # Install PostGIS extension for geospatial features
          PGPASSWORD=postgres psql -h localhost -U postgres -d forecastin_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"
        env:
          PGPASSWORD: postgres

      - name: Run backend tests with coverage
        run: |
          cd api
          pytest tests/ -v --cov=. --cov-report=term-missing --cov-report=xml --cov-report=html
        env:
          TESTING: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/forecastin_test
          REDIS_URL: redis://localhost:6379/0

      - name: Upload coverage reports
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: |
            api/.coverage
            api/coverage.xml
            api/htmlcov
          retention-days: 7

  frontend-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci --legacy-peer-deps

      - name: TypeScript type check
        run: |
          cd frontend
          npm run typecheck

      - name: Run frontend tests (Vitest)
        run: |
          cd frontend
          npm test

      - name: Build frontend for production
        run: |
          cd frontend
          npm run build
        env:
          CI: true
          GENERATE_SOURCEMAP: false

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 7

  # Optional: End-to-end tests with both frontend and backend running
  # Uncomment this job when you're ready to add E2E tests (Playwright/Cypress)
  # e2e-tests:
  #   runs-on: ubuntu-latest
  #   needs: [backend-tests, frontend-tests]
  #
  #   services:
  #     postgres:
  #       image: postgres:${{ env.POSTGRES_VERSION }}
  #       env:
  #         POSTGRES_PASSWORD: postgres
  #         POSTGRES_DB: forecastin_test
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #
  #     redis:
  #       image: redis:${{ env.REDIS_VERSION }}
  #       ports:
  #         - 6379:6379
  #       options: >-
  #         --health-cmd "redis-cli ping"
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}
  #
  #     - name: Set up Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'
  #         cache-dependency-path: frontend/package-lock.json
  #
  #     - name: Install backend dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r api/requirements.txt
  #
  #     - name: Setup PostgreSQL extensions
  #       run: |
  #         PGPASSWORD=postgres psql -h localhost -U postgres -d forecastin_test -c "CREATE EXTENSION IF NOT EXISTS ltree;"
  #         PGPASSWORD=postgres psql -h localhost -U postgres -d forecastin_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"
  #       env:
  #         PGPASSWORD: postgres
  #
  #     - name: Install frontend dependencies
  #       run: |
  #         cd frontend
  #         npm ci --legacy-peer-deps
  #
  #     - name: Start backend server
  #       run: |
  #         cd api
  #         uvicorn main:app --host 0.0.0.0 --port 9000 &
  #       env:
  #         DATABASE_URL: postgresql://postgres:postgres@localhost:5432/forecastin_test
  #         REDIS_URL: redis://localhost:6379/0
  #         ENVIRONMENT: testing
  #
  #     - name: Build and serve frontend
  #       run: |
  #         cd frontend
  #         npm run build
  #         npx serve -s build -l 3000 &
  #       env:
  #         REACT_APP_API_URL: http://localhost:9000
  #         REACT_APP_WS_URL: ws://localhost:9000
  #
  #     - name: Wait for servers to be ready
  #       run: |
  #         npx wait-on http://localhost:9000/health http://localhost:3000
  #
  #     - name: Run E2E tests
  #       run: |
  #         # Install Playwright or Cypress and run E2E tests
  #         # Example for Playwright:
  #         # npx playwright install --with-deps
  #         # npx playwright test
  #         # Example for Cypress:
  #         # npx cypress run
  #         echo "E2E tests would run here - install Playwright or Cypress first"

  # Summary job to ensure all required jobs pass
  ci-success:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.backend-tests.result }}" != "success" ] || [ "${{ needs.frontend-tests.result }}" != "success" ]; then
            echo "One or more required jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
