name: Baseline CI - Phase 0 Guardrails

# This CI workflow implements Phase 0 requirements:
# - Never lies: fails hard on any error or warning
# - No continue-on-error
# - Comprehensive checks: lint, typecheck, unit tests, builds
# - Uses pinned toolchain versions from .nvmrc and .tool-versions

on:
  push:
    branches:
      - main
      - develop
      - staging
      - 'claude/**'
  pull_request:
    branches:
      - main
      - develop
      - staging

env:
  # Ensure CI mode and strict checks
  CI: true
  NODE_ENV: test
  # Ignore pkg_resources deprecation from pip's vendored packages (GH Actions env issue)
  # but still treat all other warnings as errors
  PYTHONWARNINGS: "ignore::DeprecationWarning:pip._vendor.pkg_resources,error"
  # Treat warnings as errors for Python tools
  MYPY_FORCE_COLOR: 1
  PYTEST_ADDOPTS: "--strict-markers --strict-config"

jobs:
  # ============================================================================
  # LINT - Code quality and formatting checks
  # ============================================================================
  lint:
    name: Lint (Backend + Frontend)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read .nvmrc
        id: node-version
        run: echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.node-version.outputs.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.9'
          cache: 'pip'
          cache-dependency-path: 'api/requirements.txt'

      - name: Install Python linting tools
        run: |
          PYTHONWARNINGS="ignore::DeprecationWarning" python -m pip install --upgrade pip setuptools wheel
          pip install ruff black isort mypy bandit

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci --legacy-peer-deps

      - name: Run backend linting (ruff)
        run: |
          cd api
          ruff check . --config ../pyproject.toml
        # Fail on any linting errors

      - name: Check backend formatting (black)
        run: |
          cd api
          black --check --config ../pyproject.toml .
        # Fail if code is not formatted

      - name: Check backend import sorting (isort)
        run: |
          cd api
          isort --check-only --settings-path ../pyproject.toml .
        # Fail if imports are not sorted

      - name: Run security scan (bandit)
        run: |
          cd api
          bandit -r . -c ../pyproject.toml --severity-level medium
        # Fail on medium+ severity issues

      - name: Run frontend linting (eslint)
        run: |
          cd frontend
          npm run lint --if-present || echo "No lint script found"
        # Fail on linting errors if script exists

  # ============================================================================
  # TYPECHECK BACKEND - Python type checking
  # ============================================================================
  typecheck_backend:
    name: TypeCheck Backend (mypy)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.9'
          cache: 'pip'
          cache-dependency-path: 'api/requirements.txt'

      - name: Install dependencies
        run: |
          PYTHONWARNINGS="ignore::DeprecationWarning" python -m pip install --upgrade pip setuptools wheel
          pip install mypy types-redis
          if [ -f api/requirements.txt ]; then pip install -r api/requirements.txt; fi

      - name: Run mypy type checking
        run: |
          cd api
          mypy . --config-file ../pyproject.toml --warn-unused-ignores --warn-redundant-casts --no-implicit-optional
        # CRITICAL: Fail hard on type errors. No exceptions.

  # ============================================================================
  # TYPECHECK FRONTEND - TypeScript type checking
  # ============================================================================
  typecheck_frontend:
    name: TypeCheck Frontend (tsc)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read .nvmrc
        id: node-version
        run: echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.node-version.outputs.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci --legacy-peer-deps

      - name: Run TypeScript type checking
        run: |
          cd frontend
          npm run typecheck
        # CRITICAL: Fail hard on type errors. tsconfig must have strict: true

  # ============================================================================
  # UNIT TESTS - Backend and Frontend
  # ============================================================================
  unit:
    name: Unit Tests (Backend + Frontend)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Services for backend tests
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read .nvmrc
        id: node-version
        run: echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.9'
          cache: 'pip'
          cache-dependency-path: 'api/requirements.txt'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.node-version.outputs.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install backend dependencies
        run: |
          PYTHONWARNINGS="ignore::DeprecationWarning" python -m pip install --upgrade pip setuptools wheel
          pip install pytest pytest-asyncio pytest-cov pytest-benchmark
          if [ -f api/requirements.txt ]; then pip install -r api/requirements.txt; fi

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci --legacy-peer-deps

      - name: Run backend unit tests
        run: |
          cd api
          pytest tests/ -v --cov=. --cov-report=term-missing --cov-report=xml --tb=short --strict-markers --strict-config -m "not integration and not slow"
        env:
          TESTING: true
          DATABASE_URL: postgresql://test:test@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
        # CRITICAL: Fail if any test fails. Coverage threshold enforced by pyproject.toml

      - name: Run frontend unit tests
        run: |
          cd frontend
          npm test
        # CRITICAL: Fail if any test fails

      - name: Upload backend coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: api/coverage.xml
          retention-days: 7

      - name: Upload frontend coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 7

  # ============================================================================
  # BUILD FRONTEND - Production build verification
  # ============================================================================
  build_frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read .nvmrc
        id: node-version
        run: echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.node-version.outputs.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci --legacy-peer-deps

      - name: Build production bundle
        run: |
          cd frontend
          npm run build
        env:
          CI: true
          GENERATE_SOURCEMAP: false
        # CRITICAL: Fail if build fails. No warnings allowed in production build.

      - name: Verify build output
        run: |
          cd frontend
          if [ ! -d "dist" ] && [ ! -d "build" ]; then
            echo "ERROR: Build output directory not found"
            exit 1
          fi
          echo "Build verification passed"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

  # ============================================================================
  # BUILD BACKEND - Import validation and packaging
  # ============================================================================
  build_backend:
    name: Build Backend
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.9'
          cache: 'pip'
          cache-dependency-path: 'api/requirements.txt'

      - name: Install dependencies
        run: |
          PYTHONWARNINGS="ignore::DeprecationWarning" python -m pip install --upgrade pip setuptools wheel
          if [ -f api/requirements.txt ]; then pip install -r api/requirements.txt; fi

      - name: Verify Python package structure
        run: |
          if [ ! -f "api/__init__.py" ]; then
            echo "ERROR: api/__init__.py not found - backend is not a proper package"
            exit 1
          fi
          echo "Package structure verification passed"

      - name: Test import main app
        run: |
          cd api
          python -c "from main import app; print('✓ FastAPI app imported successfully')"
        # CRITICAL: Fail if imports are broken

      - name: Validate requirements pinning
        run: |
          cd api
          # Check that all requirements have pinned versions (==)
          if grep -E '^[^#]*[a-zA-Z0-9_-]+[^=<>]$' requirements.txt; then
            echo "ERROR: Found unpinned dependencies in requirements.txt"
            exit 1
          fi
          echo "✓ All dependencies are pinned"

  # ============================================================================
  # CI SUCCESS - Aggregation gate
  # ============================================================================
  ci-success:
    name: CI Success Gate
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck_backend
      - typecheck_frontend
      - unit
      - build_frontend
      - build_backend
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          # Fail if any required job failed
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "❌ Lint job failed"
            exit 1
          fi
          if [ "${{ needs.typecheck_backend.result }}" != "success" ]; then
            echo "❌ Backend typecheck job failed"
            exit 1
          fi
          if [ "${{ needs.typecheck_frontend.result }}" != "success" ]; then
            echo "❌ Frontend typecheck job failed"
            exit 1
          fi
          if [ "${{ needs.unit.result }}" != "success" ]; then
            echo "❌ Unit tests job failed"
            exit 1
          fi
          if [ "${{ needs.build_frontend.result }}" != "success" ]; then
            echo "❌ Frontend build job failed"
            exit 1
          fi
          if [ "${{ needs.build_backend.result }}" != "success" ]; then
            echo "❌ Backend build job failed"
            exit 1
          fi

          echo "✅ All CI jobs passed successfully!"
          echo ""
          echo "Phase 0 Guardrails: PASSED"
          echo "- Linting: ✓"
          echo "- Type checking (backend): ✓"
          echo "- Type checking (frontend): ✓"
          echo "- Unit tests: ✓"
          echo "- Frontend build: ✓"
          echo "- Backend build: ✓"
