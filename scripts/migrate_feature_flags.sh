#!/bin/bash\n#\n# Feature Flag Name Standardization Migration Script\n# Date: 2025-11-07\n# Breaking Change: YES\n#\n# This script automates the complete migration from old flag names to ff.geo.* pattern\n#\n# Usage:\n#   ./scripts/migrate_feature_flags.sh         # Run migration\n#   ./scripts/migrate_feature_flags.sh verify  # Verify migration\n#   ./scripts/migrate_feature_flags.sh rollback # Rollback migration\n\nset -euo pipefail\n\n# Colors for output\nRED='\033[0;31m'\nGREEN='\033[0;32m'\nYELLOW='\033[1;33m'\nBLUE='\033[0;34m'\nNC='\033[0m' # No Color\n\n# Configuration - Load from .env file if it exists\nif [ -f "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/.env" ]; then\n    export $(grep -v '^#' "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/.env" | xargs)\nfi\n\nDB_HOST="${DB_HOST:-localhost}"\nDB_PORT="${DB_PORT:-5432}"\nDB_NAME="${DB_NAME:-forecastin}"\nDB_USER="${DB_USER:-forecastin}"\nMIGRATION_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/migrations"\nBACKUP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/backups"\n\n# Logging functions\nlog_info() {\n    echo -e "${BLUE}[INFO]${NC} $1"\n}\n\nlog_success() {\n    echo -e "${GREEN}[SUCCESS]${NC} $1"\n}\n\nlog_warning() {\n    echo -e "${YELLOW}[WARNING]${NC} $1"\n}\n\nlog_error() {\n    echo -e "${RED}[ERROR]${NC} $1"\n}\n\n# Check prerequisites\ncheck_prerequisites() {\n    log_info "Checking prerequisites..."\n\n    # Check if PostgreSQL client is installed\n    if ! command -v psql &> /dev/null; then\n        log_error "psql command not found. Please install PostgreSQL client."\n        exit 1\n    fi\n\n    # Check if migration files exist\n    if [ ! -f "$MIGRATION_DIR/001_standardize_feature_flag_names.sql" ]; then\n        log_error "Migration file not found: $MIGRATION_DIR/001_standardize_feature_flag_names.sql"\n        exit 1\n    fi\n\n    # Check database connectivity\n    if ! psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1" &> /dev/null; then\n        log_error "Cannot connect to database. Please check connection parameters."\n        exit 1\n    fi\n\n    log_success "All prerequisites met"\n}\n\n# Create backup\ncreate_backup() {\n    log_info "Creating database backup..."\n\n    mkdir -p "$BACKUP_DIR"\n\n    local backup_file="$BACKUP_DIR/feature_flags_backup_$(date +%Y%m%d_%H%M%S).sql"\n\n    psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "\n        COPY (SELECT * FROM feature_flags)\n        TO STDOUT WITH CSV HEADER\n    " > "$backup_file"\n\n    if [ $? -eq 0 ]; then\n        log_success "Backup created: $backup_file"\n        echo "$backup_file"\n    else\n        log_error "Backup failed"\n        exit 1\n    fi\n}\n\n# Run database migration\nrun_migration() {\n    log_info "Running database migration..."\n\n    psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" \\n        -f "$MIGRATION_DIR/001_standardize_feature_flag_names.sql"\n\n    if [ $? -eq 0 ]; then\n        log_success "Database migration completed"\n    else\n        log_error "Database migration failed"\n        exit 1\n    fi\n}\n\n# Verify migration\nverify_migration() {\n    log_info "Verifying migration..."\n\n    # Count new-style flags\n    local new_style_count=$(psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" \\n        -t -c "SELECT COUNT(*) FROM feature_flags WHERE flag_name LIKE 'ff.geo%'")\n\n    # Count old-style flags (should be 0)\n    local old_style_count=$(psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" \\n        -t -c "SELECT COUNT(*) FROM feature_flags\n               WHERE flag_name LIKE 'ff_%'\n               AND flag_name NOT LIKE 'ff.%'\n               AND flag_name != 'ff.map_v1'")\n\n    log_info "New-style flags (ff.geo.*): $new_style_count"\n    log_info "Old-style flags (ff_*): $old_style_count"\n\n    if [ "$old_style_count" -gt 0 ]; then\n        log_error "Migration incomplete: $old_style_count old-style flags remain"\n\n        # List remaining old-style flags\n        psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" \\n            -c "SELECT flag_name FROM feature_flags\n                WHERE flag_name LIKE 'ff_%'\n                AND flag_name NOT LIKE 'ff.%'\n                AND flag_name != 'ff.map_v1'"\n\n        exit 1\n    fi\n\n    log_success "Migration verification passed"\n    log_success "All $new_style_count flags use ff.geo.* naming"\n}\n\n# Rollback migration\nrollback_migration() {\n    log_warning "Rolling back migration..."\n\n    read -p "Are you sure you want to rollback? This will restore old flag names. (yes/no): " confirm\n\n    if [ "$confirm" != "yes" ]; then\n        log_info "Rollback cancelled"\n        exit 0\n    fi\n\n    psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" \\n        -f "$MIGRATION_DIR/001_standardize_feature_flag_names_ROLLBACK.sql"\n\n    if [ $? -eq 0 ]; then\n        log_success "Rollback completed"\n    else\n        log_error "Rollback failed"\n        exit 1\n    fi\n}\n\n# Test migration on staging\ntest_migration() {\n    log_info "Testing migration (dry run)..."\n\n    # Create test transaction\n    psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" <<EOF\nBEGIN;\n$(cat "$MIGRATION_DIR/001_standardize_feature_flag_names.sql" | sed '/^COMMIT;/d')\nROLLBACK;\nEOF\n\n    if [ $? -eq 0 ]; then\n        log_success "Migration test passed (changes rolled back)"\n    else\n        log_error "Migration test failed"\n        exit 1\n    fi\n}\n\n# Main execution\nmain() {\n    local command="${1:-migrate}"\n\n    echo "=========================================="\n    echo "Feature Flag Name Standardization"\n    echo "=========================================="\n    echo ""\n\n    case "$command" in\n        migrate)\n            check_prerequisites\n            create_backup\n            run_migration\n            verify_migration\n\n            log_success "Migration complete!"\n            log_info "Next steps:"\n            log_info "1. Restart backend service: docker-compose restart api"\n            log_info "2. Rebuild frontend: cd frontend && npm run build"\n            log_info "3. Restart frontend service: docker-compose restart frontend"\n            log_info "4. Verify with: ./scripts/migrate_feature_flags.sh verify"\n            ;;\n\n        verify)\n            check_prerequisites\n            verify_migration\n            ;;\n\n        rollback)\n            check_prerequisites\n            rollback_migration\n            ;;\n\n        test)\n            check_prerequisites\n            test_migration\n            ;;\n\n        *)\n            log_error "Unknown command: $command"\n            echo "Usage: $0 {migrate|verify|rollback|test}"\n            exit 1\n            ;;\n    esac\n}\n\n# Run main function\nmain "$@"\n