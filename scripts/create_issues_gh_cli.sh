#!/bin/bash
# GitHub Issue Creation Script for glockpete/Forecastin
# Method: CLI
# Total issues: 11

# Set up environment
set -e

# Issue creation commands:
gh issue create --repo glockpete/Forecastin --title "Missing Type Exports Block TypeScript Compilation" --body "## Description\nTypeScript compilation fails with 89 errors due to missing exports in `types/contracts.generated.ts`. The file is missing exports for utility functions and types that are imported by multiple components.\n\n## Impact\n- **Blocks development:** TypeScript compilation fails, preventing builds\n- **Affected files:** 5+ component files including EntityDetail.tsx, MillerColumns.tsx, SearchInterface.tsx\n- **Category:** Type System\n\n## Affected Components\n- `getConfidence` function (3 import attempts)\n- `getChildrenCount` function (2 import attempts)\n- `Entity` type from useHierarchy.ts (1 import)\n- `fromEntityId` function (1 import, should be `EntityId`)\n\n## Reproduction Steps\n1. Run `npx tsc --noEmit`\n2. Observe errors in:\n- EntityDetail.tsx:24\n- MillerColumns.tsx:42\n- SearchInterface.tsx:21\n3. Error message: \"Module has no exported member 'getConfidence'\"\n\n## Expected Behavior\nAll types and utility functions should be properly exported from `contracts.generated.ts` and available for import.\n\n## Actual Behavior\nTypeScript compilation fails with \"Module has no exported member\" errors.\n\n## Proposed Fix\n### Option 1: Add utility exports to contracts.generated.ts\n```typescript\nexport function getConfidence(entity: Entity): number {\nreturn entity.confidence ?? 0;\n}\nexport function getChildrenCount(entity: Entity): number {\nreturn entity.childrenCount ?? 0;\n}\n```\n### Option 2: Export Entity from useHierarchy.ts\n```typescript\nexport type { Entity } from '../types';\n```\n\n## Code References\n- **File:** `types/contracts.generated.ts`\n- **Related:** REPORT.md Section 2, Category 1\n- **Estimated Fix Time:** 15 minutes\n\n## Acceptance Criteria\n- [ ] TypeScript compilation succeeds without errors\n- [ ] All missing exports are properly defined\n- [ ] All affected components can import required types/functions\n- [ ] No regression in existing functionality\n\n## Additional Context\nThis issue blocks development workflow and should be addressed immediately to unblock the team." --label "bug,critical,typescript,compilation"
gh issue create --repo glockpete/Forecastin --title "Test Fixtures Missing Required layerId Property" --body "## Description\nMessageDeduplicator tests fail with \"Cannot read properties of undefined (reading 'layerId')\" because test message fixtures don't include the `data.layerId` property required by `LayerDataUpdateMessage` schema.\n\n## Impact\n- **Test failures:** 8 test failures in realtimeHandlers.test.ts\n- **WebSocket validation broken:** Message validation fails due to missing required properties\n- **Category:** Testing\n\n## Affected Components\n- `tests/realtimeHandlers.test.ts` - MessageDeduplicator test suite\n- WebSocket message validation system\n\n## Reproduction Steps\n1. Run `npm test`\n2. Observe 8 failures in MessageDeduplicator test suite\n3. Error at `src/types/ws_messages.ts:969` - `layerMsg.data.layerId`\n4. Error message: \"Cannot read properties of undefined (reading 'layerId')\"\n\n## Expected Behavior\nTest messages should match `LayerDataUpdateMessage` schema with all required properties, including `data.layerId`.\n\n## Actual Behavior\nTest messages are missing the `data.layerId` property, causing undefined access error during validation.\n\n## Proposed Fix\nUpdate test fixtures in `tests/realtimeHandlers.test.ts` to include the required `layerId` property:\n```typescript\nconst testMessage: LayerDataUpdateMessage = {\ntype: 'layer_data_update',\ndata: {\nlayerId: 'test-layer-1',  // ADD THIS REQUIRED PROPERTY\noperation: 'update',\nlayerType: 'point',\nentities: [],\naffectedBounds: { /* ... */ }\n},\ntimestamp: Date.now()\n};\n```\n\n## Code References\n- **File:** `tests/realtimeHandlers.test.ts`\n- **Schema:** `src/types/ws_messages.ts` - LayerDataUpdateMessage definition\n- **Related:** REPORT.md Section 3, Failed Tests 1-8\n- **Estimated Fix Time:** 30 minutes\n\n## Acceptance Criteria\n- [ ] All MessageDeduplicator tests pass\n- [ ] Test fixtures include all required properties per WebSocket message schemas\n- [ ] No undefined property access errors during test execution\n- [ ] WebSocket message validation works correctly in tests\n\n## Additional Context\nThis issue affects the reliability of WebSocket message handling tests and should be fixed to ensure proper validation of real-time data updates." --label "bug,critical,testing,websocket"
gh issue create --repo glockpete/Forecastin --title "HierarchyResponse Type Missing .entities Property" --body "## Description\nFrontend code expects `HierarchyResponse<EntityType>` to have an `.entities` property, but the type definition doesn't include it. This causes TypeScript errors and potential runtime failures in navigation components.\n\n## Impact\n- **TypeScript errors:** 6 compilation errors\n- **Data access broken:** Navigation components cannot access entity data\n- **Category:** Type System / API Contract\n\n## Affected Components\n- MillerColumns.tsx (lines 160, 213, 329)\n- SearchInterface.tsx (lines 78, 80, 195)\n\n## Reproduction Steps\n1. Run `npx tsc --noEmit`\n2. Observe errors at:\n- MillerColumns.tsx:160,213,329\n- SearchInterface.tsx:78,80,195\n3. Error message: \"Property 'entities' does not exist on type 'HierarchyResponse<EntityType>'\"\n\n## Expected Behavior\n`HierarchyResponse` should include an `entities` array property:\n```typescript\ninterface HierarchyResponse<T extends EntityType> {\nentities: Entity<T>[];\ntotal?: number;\nhasMore?: boolean;\n}\n```\n\n## Actual Behavior\nType definition is missing the `.entities` property that frontend code expects and uses.\n\n## Proposed Fix\n### Option 1: Add .entities property to HierarchyResponse interface\nAdd the missing property to the `HierarchyResponse` interface in `types/index.ts`:\n```typescript\ninterface HierarchyResponse<T extends EntityType> {\nentities: Entity<T>[];\ntotal?: number;\nhasMore?: boolean;\n}\n```\n### Option 2: Update frontend code (if backend returns different property)\nIf the backend returns entities under a different property name, update frontend code to use the correct property.\n\n## Code References\n- **Files:** `MillerColumns.tsx`, `SearchInterface.tsx`\n- **Type Definition:** `types/index.ts` - HierarchyResponse interface\n- **Related:** REPORT.md Section 2, Category 2; checks/api_ui_drift.md Section 3 Issue 1\n- **Estimated Fix Time:** 15 minutes (type fix) or 1 hour (refactor frontend code)\n\n## Acceptance Criteria\n- [ ] TypeScript compilation succeeds without HierarchyResponse errors\n- [ ] Navigation components can access entity data properly\n- [ ] API contract between frontend and backend is consistent\n- [ ] No runtime data access failures\n\n## Additional Context\nThis issue represents an API contract mismatch between frontend expectations and backend responses. The fix should align the type definitions with actual data structures." --label "bug,critical,typescript,api-contract"
gh issue create --repo glockpete/Forecastin --title "Missing Enum Definitions in Generated Contracts" --body "## Description\n`contracts.generated.ts` references `RiskLevel` and `ValidationStatus` enums that are not defined, causing TypeScript compilation errors. The generated contract file contains references to types that don't exist.\n\n## Impact\n- **TypeScript errors:** 3 compilation errors\n- **Contract types incomplete:** Generated API contracts are missing required type definitions\n- **Category:** Type System / Code Generation\n\n## Affected Components\n- `types/contracts.generated.ts` (lines 89, 122, 165)\n\n## Reproduction Steps\n1. Run `npx tsc --noEmit`\n2. Observe errors at types/contracts.generated.ts:89,122,165\n3. Error messages:\n- \"Cannot find name 'RiskLevel'\"\n- \"Cannot find name 'ValidationStatus'\"\n\n## Expected Behavior\nAll referenced types in generated contracts should be properly defined or imported.\n\n## Actual Behavior\nEnums are referenced in the generated code but not defined, causing compilation failures.\n\n## Proposed Fix\n### Option 1: Regenerate Contracts (Recommended)\nRun the contract generator to ensure all types are properly generated:\n```bash\npython scripts/dev/generate_contracts.py\n```\n### Option 2: Manual Enum Definitions\nIf regeneration doesn't work, manually add the missing enum definitions to `contracts.generated.ts`:\n```typescript\nexport enum RiskLevel {\nLOW = 'low',\nMEDIUM = 'medium',\nHIGH = 'high',\nCRITICAL = 'critical'\n}\nexport enum ValidationStatus {\nPENDING = 'pending',\nVALID = 'valid',\nINVALID = 'invalid'\n}\n```\n\n## Code References\n- **File:** `types/contracts.generated.ts`\n- **Generator:** `scripts/dev/generate_contracts.py`\n- **Related:** REPORT.md Section 2, Category 7; checks/api_ui_drift.md Section 3 Issue 3\n- **Estimated Fix Time:** 5 minutes (regenerate) or 15 minutes (manual)\n\n## Acceptance Criteria\n- [ ] TypeScript compilation succeeds without missing enum errors\n- [ ] All referenced types in contracts.generated.ts are properly defined\n- [ ] Contract generation process produces complete type definitions\n- [ ] No manual type definitions required after regeneration\n\n## Additional Context\nThis issue suggests a problem with the contract generation process. The preferred solution is to fix the generator rather than manually patching the output file." --label "bug,critical,typescript,code-generation"
gh issue create --repo glockpete/Forecastin --title "api/main.py Exceeds Maintainability Threshold" --body "## Description\n`api/main.py` contains 2,014 lines combining FastAPI app initialization, route handlers, middleware, startup/shutdown logic, and configuration. This violates the single responsibility principle and makes the codebase difficult to maintain and test.\n\n## Impact\n- **Maintenance burden:** Difficult to navigate and modify\n- **Testing challenges:** Hard to isolate and test individual components\n- **Architecture violation:** Mixed concerns violate single responsibility principle\n- **Category:** Architecture / Code Organization\n\n## Affected Components\n- `api/main.py` (2,014 LOC) - Primary application file\n\n## Reproduction Steps\n1. Open `api/main.py`\n2. Observe file length: `wc -l api/main.py` ‚Üí 2,014\n3. Observe mixed concerns: routes, middleware, configuration all in one file\n4. Note difficulty in locating specific functionality\n\n## Expected Behavior\nFastAPI application should be organized into modular components:\n```\napi/\n‚îú‚îÄ‚îÄ main.py (200-300 LOC) - App initialization only\n‚îú‚îÄ‚îÄ routers/\n‚îÇ   ‚îú‚îÄ‚îÄ hierarchy.py - Hierarchy endpoints\n‚îÇ   ‚îú‚îÄ‚îÄ entities.py - Entity CRUD\n‚îÇ   ‚îú‚îÄ‚îÄ scenarios.py - Scenario endpoints\n‚îÇ   ‚îú‚îÄ‚îÄ websocket.py - WebSocket endpoints\n‚îÇ   ‚îî‚îÄ‚îÄ feature_flags.py - Feature flag endpoints\n‚îî‚îÄ‚îÄ middleware/\n‚îú‚îÄ‚îÄ auth.py\n‚îú‚îÄ‚îÄ cors.py\n‚îî‚îÄ‚îÄ error_handlers.py\n```\n\n## Actual Behavior\nAll application concerns are mixed in a single 2,014-line file, making it difficult to maintain and extend.\n\n## Proposed Fix\nRefactor into modular structure following FastAPI best practices:\n### Phase 1: Extract Routers\n- Move route handlers to dedicated router modules\n- Group routes by domain (hierarchy, entities, scenarios, etc.)\n### Phase 2: Extract Middleware\n- Move middleware functions to separate modules\n- Organize by functionality (auth, CORS, error handling)\n### Phase 3: Extract Configuration\n- Move configuration logic to `config.py`\n- Separate environment-specific settings\n### Phase 4: Extract Startup/Shutdown Logic\n- Move lifecycle events to dedicated modules\n- Improve testability of initialization code\n\n## Code References\n- **File:** `api/main.py`\n- **Related:** SCOUT_LOG.md Section 4, Critical Issue 1\n- **Estimated Fix Time:** 4-6 hours with full test coverage\n\n## Acceptance Criteria\n- [ ] `main.py` reduced to 200-300 lines (app initialization only)\n- [ ] All route handlers moved to dedicated router modules\n- [ ] Middleware extracted to separate modules\n- [ ] Configuration logic separated from application code\n- [ ] All existing functionality preserved\n- [ ] Test coverage maintained or improved\n- [ ] Code follows FastAPI best practices\n\n## Additional Context\nThis refactor is critical for long-term maintainability and will make the codebase more approachable for new developers. The modular structure will also improve testability and deployment flexibility." --label "refactor,critical,architecture,maintainability"
gh issue create --repo glockpete/Forecastin --title "Schema Mismatch in Hierarchy Resolver (Critical Performance Issue)" --body "## Description\nCritical schema mismatch in the hierarchy resolver completely breaks the L4 cache layer, causing 177% performance degradation. SQL queries reference `e.entity_id` column which doesn't exist (correct column is `e.id`), resulting in JOIN failures and degraded performance.\n\n## Impact\n- **Performance:** 3.46ms actual vs 1.25ms target (177% over target)\n- **Cache Layer:** L4 cache completely broken, L3 queries degraded\n- **Query Reliability:** Silent JOIN failures masked by COALESCE operations\n\n## Evidence from Documentation\n### Honest Review Critical Finding ([`checks/HONEST_REVIEW.md`](checks/HONEST_REVIEW.md:55-92))\nThe review identifies this as the most critical issue in the codebase:\n```python\n# BEFORE (line 510-522):\ncur.execute(\"\"\"\nSELECT\ne.entity_id,  # ‚ùå WRONG - column doesn't exist\ne.path,\ne.path_depth,\ne.path_hash,\ne.confidence_score,\nCOALESCE(mv.ancestors, ARRAY[]::text[]) as ancestors,\nCOALESCE(mv.descendant_count, 0) as descendants\nFROM entities e\nLEFT JOIN mv_entity_ancestors mv ON e.entity_id = mv.entity_id  # ‚ùå JOIN fails\nWHERE e.entity_id = %s  # ‚ùå WHERE clause never matches\nLIMIT 1\n\"\"\", (entity_id,))\n# AFTER:\ncur.execute(\"\"\"\nSELECT\ne.id as entity_id,  # ‚úÖ CORRECT\ne.path,\ne.path_depth,\ne.path_hash,\ne.confidence_score,\nCOALESCE(mv.ancestors, ARRAY[]::text[]) as ancestors,\nCOALESCE(mv.descendant_count, 0) as descendants\nFROM entities e\nLEFT JOIN mv_entity_ancestors mv ON e.id = mv.entity_id  # ‚úÖ JOIN works\nWHERE e.id = %s  # ‚úÖ WHERE clause matches\nLIMIT 1\n\"\"\", (entity_id,))\n```\n### Performance Impact Analysis\n- **Target Performance:** <1.25ms ancestor resolution (P95 <1.87ms)\n- **Current Performance:** 3.46ms actual (177% degradation)\n- **Cache Strategy:** Four-tier caching (L1 Memory ‚Üí L2 Redis ‚Üí L3 Database ‚Üí L4 Materialized Views)\n\n## Root Cause Analysis\n### Silent JOIN Failures ([`checks/HONEST_REVIEW.md`](checks/HONEST_REVIEW.md:151-166))\nThe COALESCE operations mask JOIN failures, making the issue difficult to detect:\n```python\n# LEFT JOIN succeeds but returns NULLs due to schema mismatch\nCOALESCE(mv.ancestors, ARRAY[]::text[]) as ancestors  # Masks the failure\n```\n### Missing Query Validation\nNo validation method exists to detect schema mismatches in query results.\n\n## Proposed Solution\n### Immediate Fix (Critical)\n1. **Fix Column References:** Replace `e.entity_id` with `e.id` in all affected queries\n2. **Add Query Validation:** Implement validation to detect JOIN failures\n3. **Performance Testing:** Verify performance returns to <1.25ms target\n### Validation Method\n```python\ndef _validate_query_result(self, row: Dict) -> bool:\n\"\"\"Validate query results to catch schema mismatches.\"\"\"\nrequired_fields = ['entity_id', 'path', 'path_depth', 'path_hash']\nfor field in required_fields:\nif field not in row or row[field] is None:\nself.logger.error(f\"Query validation failed: missing or NULL field '{field}'\")\nreturn False\nreturn True\n```\n\n## Affected Components\n- [`api/navigation_api/database/optimized_hierarchy_resolver.py`](api/navigation_api/database/optimized_hierarchy_resolver.py) - Core resolver\n- Materialized view refresh operations\n- Cache invalidation logic\n\n## Risk Assessment\n### üü¢ LOW RISK (After Fix)\n- Simple column reference correction\n- No architectural changes required\n- Immediate performance improvement\n### üü° MEDIUM RISK (Current State)\n- Performance degradation affecting user experience\n- Cache layer ineffective\n- Potential data consistency issues\n### üî¥ HIGH RISK (If Unfixed)\n- Continued performance degradation\n- Cache layer remains broken\n- Scaling limitations\n\n## Acceptance Criteria\n- [ ] All SQL queries use correct column references (`e.id` instead of `e.entity_id`)\n- [ ] Query validation method implemented to detect schema mismatches\n- [ ] Performance returns to <1.25ms target (P95 <1.87ms)\n- [ ] L4 cache layer functioning correctly\n- [ ] No silent JOIN failures\n\n## Estimated Effort\n**Small (S) - 1-2 hours** for immediate fix including testing\n\n## Related Documentation\n- [`checks/HONEST_REVIEW.md`](checks/HONEST_REVIEW.md) - Comprehensive analysis\n- Performance targets and SLO validation requirements\n- Four-tier caching architecture documentation\n\n## Additional Context\nThis issue represents the single most critical performance blocker in the codebase. The sophisticated four-tier caching strategy with RLock thread safety is currently undermined by this simple schema mismatch. Fixing this will immediately restore the platform's performance targets and enable proper cache utilization." --label "bug,critical,performance,database,cache"
gh issue create --repo glockpete/Forecastin --title "Feature Flag Infrastructure Unused (88% Adoption Gap)" --body "## Description\nFeature flag infrastructure is fully implemented but only 1 out of 9 defined flags is used, creating an 88% adoption gap. Layer implementations don't check flags before executing, preventing gradual rollout and safe testing.\n\n## Impact\n- **Deployment Risk:** Cannot gradually roll out geospatial features\n- **Testing Limitation:** Cannot A/B test layer rendering performance\n- **Rollback Inability:** Cannot quickly rollback problematic changes\n- **Monitoring Gap:** Cannot monitor performance per feature\n\n## Evidence from Documentation\n### Feature Flag Migration Status ([`feature_flag_migration_status.md`](feature_flag_migration_status.md:24-43))\nThe migration report shows feature flag naming standardization is ready but database connectivity prevents verification:\n- **Migration Prepared:** All migration files properly prepared\n- **Service Compatibility:** Code handles both old and new naming patterns\n- **Database Blocked:** Cannot verify current feature flag state due to connectivity issues\n### Honest Review Findings ([`checks/HONEST_REVIEW.md`](checks/HONEST_REVIEW.md:113-126))\nThe review identifies inconsistent feature flag naming patterns as a critical issue:\n- **Pattern Mix:** `ff.flag_name` (dot notation) vs `ff_flag_name` (underscore)\n- **Maintenance Complexity:** Creates configuration errors and maintenance burden\n### Bug Report Details ([`checks/bug_report.md`](checks/bug_report.md:626-664))\nDetailed analysis shows the extent of the problem:\n- **Defined Flags (9 total):**\n- ‚úÖ `ff.map_v1` - USED (2 components)\n- ‚ùå `ff.geospatial_layers` - NOT USED\n- ‚ùå `ff.point_layer` - NOT USED\n- ‚ùå `ff.polygon_layer` - NOT USED\n- ‚ùå `ff.heatmap_layer` - NOT USED\n- ‚ùå `ff.clustering_enabled` - NOT USED\n- ‚ùå `ff.gpu_filtering` - NOT USED\n- ‚ùå `ff.websocket_layers` - NOT USED\n- ‚ùå `ff.realtime_updates` - NOT USED\n\n## Affected Components\n- [`api/services/feature_flag_service.py`](api/services/feature_flag_service.py) - Backend service\n- Layer implementations (PointLayer, PolygonLayer, HeatmapLayer, etc.)\n- [`LayerWebSocketIntegration`](frontend/src/integrations/LayerWebSocketIntegration.ts) - Frontend integration\n\n## Proposed Solution\n### Phase 1: Database Connectivity Resolution\n```bash\n# Resolve database access as identified in migration status\npsql -h localhost -U postgres -d postgres -c \"SELECT 1;\"\n# Or alternative credentials\npsql -h localhost -U forecastin -d forecastin -c \"SELECT 1;\"\n```\n### Phase 2: Feature Flag Integration\nAdd flag checks to all layer implementations:\n```typescript\n// In PointLayer.ts constructor\nconst { isEnabled } = useFeatureFlag('ff.point_layer');\nif (!isEnabled) {\nreturn null; // Or throw error\n}\n```\n### Phase 3: Standardization Migration\nExecute the prepared migration:\n```bash\n./scripts/migrate_feature_flags.sh migrate\n```\n\n## Acceptance Criteria\n- [ ] Database connectivity resolved and current flag state verified\n- [ ] All 8 unused feature flags integrated into layer implementations\n- [ ] Feature flag naming standardized to dot notation\n- [ ] Gradual rollout mechanism tested (10% ‚Üí 25% ‚Üí 50% ‚Üí 100%)\n- [ ] Rollback procedure validated\n\n## Estimated Effort\n**6-8 hours** for all integrations including testing\n\n## Related Issues\n- Feature flag migration blocked by database connectivity\n- Inconsistent naming patterns across codebase\n- Need for safe deployment mechanisms\n\n## Additional Context\nThe feature flag system supports sophisticated capabilities including:\n- Multi-tier caching (L1 Memory ‚Üí L2 Redis ‚Üí L3 Database ‚Üí L4 Materialized Views)\n- WebSocket notifications for real-time updates\n- Thread-safe operations with RLock synchronization\n- Performance targets: <1.25ms response time, 99.2% cache hit rate\nThis infrastructure is currently underutilized, representing significant deployment risk." --label "bug,feature-flags,infrastructure,deployment-risk"
gh issue create --repo glockpete/Forecastin --title "Test Coverage Improvement (BUG-002, BUG-008, BUG-009)" --body "## Description\nThree critical test-related issues require immediate attention to restore test reliability and coverage. These issues affect WebSocket message validation, geospatial integration tests, and layer type guards.\n\n## Issues Included\n1. **BUG-002:** Test fixtures missing required `layerId` property\n2. **BUG-008:** Test framework mismatch in GeospatialIntegrationTests\n3. **BUG-009:** Missing type guards in layer-types.test.ts\n\n## Evidence from Documentation\n### BUG-002: Test Fixtures Missing layerId ([`checks/bug_report.md`](checks/bug_report.md:66-104))\n```typescript\nconst testMessage: LayerDataUpdateMessage = {\ntype: 'layer_data_update',\ndata: {\nlayerId: 'test-layer-1',  // ADD THIS REQUIRED PROPERTY\noperation: 'update',\nlayerType: 'point',\nentities: [],\naffectedBounds: { /* ... */ }\n},\ntimestamp: Date.now()\n};\n```\n### BUG-008: Test Framework Mismatch ([`checks/bug_report.md`](checks/bug_report.md:332-369))\n```typescript\n// Before\nimport { describe, it, expect } from '@jest/globals';\n// After\nimport { describe, it, expect } from 'vitest';\n// Replace Jest APIs:\n// jest.fn() ‚Üí vi.fn()\n// jest.mock() ‚Üí vi.mock()\n// jest.spyOn() ‚Üí vi.spyOn()\n```\n### BUG-009: Missing Type Guards ([`checks/bug_report.md`](checks/bug_report.md:373-425))\n```typescript\nexport function isLayerData(value: unknown): value is LayerData {\nreturn (\ntypeof value === 'object' &&\nvalue !== null &&\n'layerId' in value &&\n'layerType' in value\n);\n}\nexport function isVisualChannel(value: unknown): value is VisualChannel {\nreturn (\ntypeof value === 'object' &&\nvalue !== null &&\n'name' in value &&\n'type' in value\n);\n}\nexport function isGPUFilterConfig(value: unknown): value is GPUFilterConfig {\nreturn (\ntypeof value === 'object' &&\nvalue !== null &&\n'enabled' in value\n);\n}\n```\n\n## Test Coverage Context\n### Current Coverage Status ([`checks/HONEST_REVIEW.md`](checks/HONEST_REVIEW.md:273-276))\n### Integration Test Gap ([`checks/HONEST_REVIEW.md`](checks/HONEST_REVIEW.md:212-216))\n\n## Affected Components\n### BUG-002 (WebSocket Validation)\n- `tests/realtimeHandlers.test.ts` - MessageDeduplicator test suite\n- WebSocket message validation system\n- `src/types/ws_messages.ts` - LayerDataUpdateMessage schema\n### BUG-008 (Geospatial Tests)\n- `src/layers/tests/GeospatialIntegrationTests.test.ts` - Geospatial integration tests\n- Test framework configuration\n### BUG-009 (Layer Type Guards)\n- `src/layers/types/layer-types.test.ts` - Layer type validation tests\n- `src/layers/types/layer-types.ts` - Type guard implementations\n\n## Proposed Solution\n### Phase 1: Immediate Test Fixes (Critical)\n1. **Fix BUG-002:** Update test fixtures with required `layerId` property\n2. **Fix BUG-008:** Replace Jest imports with Vitest equivalents\n3. **Fix BUG-009:** Implement missing type guards\n### Phase 2: Test Coverage Expansion\n1. **Create Integration Test Suite:** Add `tests/integration/` directory\n2. **Add Performance Tests:** Validate <1.25ms performance targets\n3. **Expand WebSocket Tests:** Cover all 28+ message types\n### Phase 3: Continuous Improvement\n1. **Add Coverage Requirements:** Enforce 90%+ coverage in CI\n2. **Performance Monitoring:** Add SLO validation to tests\n3. **Security Testing:** Include message validation fuzzing\n\n## Acceptance Criteria\n### BUG-002 Acceptance\n- [ ] All MessageDeduplicator tests pass\n- [ ] Test fixtures include all required properties per WebSocket message schemas\n- [ ] No undefined property access errors during test execution\n- [ ] WebSocket message validation works correctly in tests\n### BUG-008 Acceptance\n- [ ] GeospatialIntegrationTests.test.ts executes without errors\n- [ ] All Vitest imports correctly configured\n- [ ] Jest APIs replaced with Vitest equivalents\n- [ ] Test file contributes to coverage metrics\n### BUG-009 Acceptance\n- [ ] layer-types.test.ts executes without ReferenceError\n- [ ] All type guards implemented and exported\n- [ ] Type validation tests pass\n- [ ] Type guards used in production code where appropriate\n\n## Estimated Effort\n**Total: 2-3 hours**\n- **BUG-002:** 30 minutes\n- **BUG-008:** 30 minutes\n- **BUG-009:** 1 hour\n- **Testing & Validation:** 30 minutes\n\n## Related Documentation\n- [`checks/bug_report.md`](checks/bug_report.md) - Comprehensive bug analysis\n- [`checks/HONEST_REVIEW.md`](checks/HONEST_REVIEW.md) - Codebase review findings\n- Test coverage requirements and performance targets\n\n## Additional Context\nThese test issues represent critical gaps in the testing infrastructure that prevent reliable validation of core functionality. Fixing them will:\n- Restore test reliability for WebSocket message handling\n- Enable geospatial feature testing\n- Improve type safety through proper validation\n- Contribute to overall test coverage goals\nThe platform's sophisticated architecture (four-tier caching, WebSocket validation, performance targets) requires robust testing to ensure reliability at scale." --label "testing,bug,coverage,websocket,geospatial"
gh issue create --repo glockpete/Forecastin --title "Constructor Signature Inconsistencies Across Service Implementations" --body "## Description\nMultiple service classes exhibit inconsistent constructor signatures and initialization patterns, leading to test fragility and maintenance challenges. The codebase shows varying approaches to dependency injection and service initialization across different implementations.\n\n## Evidence from Codebase\n### 1. Inconsistent Constructor Patterns\n**WebSocketManager** ([`api/services/websocket_manager.py:202`](api/services/websocket_manager.py:202)):\n```python\ndef __init__(\nself,\nmax_connections: int = 1000,\nmessage_batch_size: int = 10,\nbatch_timeout: float = 0.1,\nheartbeat_interval: float = 30.0,\nmax_message_size: int = 1024 * 1024,\nenable_metrics: bool = True\n):\n```\n**HierarchicalForecastManager** ([`api/services/hierarchical_forecast_service.py:185`](api/services/hierarchical_forecast_service.py:185)):\n```python\ndef __init__(\nself,\ncache_service: CacheService,\nrealtime_service: RealtimeService,\nhierarchy_resolver: OptimizedHierarchyResolver,\ndb_pool=None\n):\n```\n**FeatureFlagService** ([`api/services/feature_flag_service.py:190`](api/services/feature_flag_service.py:190)):\n```python\ndef __init__(\nself,\ndatabase_manager: DatabaseManager,\ncache_service: Optional[CacheService] = None,\nrealtime_service: Optional[RealtimeService] = None\n):\n```\n**AutomatedRefreshService** ([`api/services/automated_refresh_service.py:29`](api/services/automated_refresh_service.py:29)):\n```python\ndef __init__(self, db_manager: DatabaseManager, cache_service: CacheService,\nfeature_flag_service: FeatureFlagService):\n```\n### 2. Test Fixture Inconsistencies\n**ScenarioValidationEngine** ([`api/tests/test_scenario_validation.py:66`](api/tests/test_scenario_validation.py:66)):\n```python\ndef validation_engine(\nmock_cache_service,\nmock_realtime_service,\nmock_hierarchy_resolver,\nmock_forecast_manager\n):\nreturn ScenarioValidationEngine(\ncache_service=mock_cache_service,\nrealtime_service=mock_realtime_service,\nhierarchy_resolver=mock_hierarchy_resolver,\nforecast_manager=mock_forecast_manager\n)\n```\n**FeatureFlagService** ([`api/tests/test_feature_flag_service.py:58`](api/tests/test_feature_flag_service.py:58)):\n```python\ndef feature_flag_service(self, mock_db_manager, mock_cache_service, mock_realtime_service):\nservice = FeatureFlagService(\ndb_manager=mock_db_manager,\ncache_service=mock_cache_service,\nrealtime_service=mock_realtime_service\n)\n```\n\n## Issues Identified\n1. **Mixed Required/Optional Parameters**: Some services require all dependencies, others make them optional\n2. **Inconsistent Naming**: `db_pool` vs `database_manager` vs `db_manager`\n3. **Missing Type Hints**: `db_pool=None` without type annotation\n4. **Test Fixture Complexity**: Fixtures must match exact constructor signatures\n\n## Impact\n- **Test Maintenance**: Changes to constructor signatures require updating multiple test fixtures\n- **Code Consistency**: Inconsistent patterns make the codebase harder to understand\n- **Dependency Management**: Optional dependencies can lead to runtime errors\n\n## Recommended Solution\n1. **Standardize Constructor Signatures**: Adopt consistent patterns for required vs optional dependencies\n2. **Use Typed Optional Parameters**: Replace `db_pool=None` with `db_pool: Optional[Any] = None`\n3. **Create Base Service Class**: Define common initialization patterns\n4. **Improve Test Fixtures**: Use factory patterns to reduce coupling\n\n## Related Files\n- `api/services/websocket_manager.py`\n- `api/services/hierarchical_forecast_service.py`\n- `api/services/feature_flag_service.py`\n- `api/services/automated_refresh_service.py`\n- `api/tests/test_scenario_validation.py`\n- `api/tests/test_feature_flag_service.py`" --label ""
gh issue create --repo glockpete/Forecastin --title "Async Mocking Framework Issues and Inconsistent Patterns" --body "## Description\nThe test suite exhibits inconsistent async mocking patterns, improper AsyncMock usage, and framework-specific issues that affect test reliability and maintainability. Multiple test files show varying approaches to mocking async services.\n\n## Evidence from Codebase\n### 1. Inconsistent AsyncMock Usage Patterns\n**WebSocketManager Tests** ([`api/tests/test_websocket_manager.py:202`](api/tests/test_websocket_manager.py:202)):\n```python\n@pytest.fixture\ndef mock_websocket(self):\n\"\"\"Create mock WebSocket connection\"\"\"\nws = AsyncMock()\nws.send = AsyncMock()\nreturn ws\n```\n**Scenario Service Tests** ([`api/tests/test_scenario_service.py:32`](api/tests/test_scenario_service.py:32)):\n```python\n@pytest.fixture\ndef mock_cache_service():\n\"\"\"Mock CacheService for testing\"\"\"\ncache = AsyncMock()\ncache.get = AsyncMock(return_value=None)\ncache.set = AsyncMock(return_value=True)\ncache.delete = AsyncMock(return_value=True)\ncache.get_stats = Mock(return_value={\"cache_hit_rate\": 0.992})\nreturn cache\n```\n**FeatureFlag Service Tests** ([`api/tests/test_feature_flag_service.py:33`](api/tests/test_feature_flag_service.py:33)):\n```python\n@pytest.fixture\ndef mock_db_manager(self):\n\"\"\"Mock DatabaseManager for testing\"\"\"\ndb_manager = AsyncMock()\ndb_manager.fetchrow = AsyncMock()\ndb_manager.fetch = AsyncMock(return_value=[])\ndb_manager.execute = AsyncMock()\nreturn db_manager\n```\n### 2. Mixed Mock/AsyncMock Patterns\n**ScenarioValidationEngine Tests** ([`api/tests/test_scenario_validation.py:34`](api/tests/test_scenario_validation.py:34)):\n```python\n@pytest.fixture\ndef mock_cache_service():\n\"\"\"Mock cache service for testing\"\"\"\nservice = Mock(spec=CacheService)  # Using Mock instead of AsyncMock\nservice.get = AsyncMock(return_value=None)\nservice.set = AsyncMock(return_value=True)\nreturn service\n```\n### 3. Complex Mock Setup Issues\n**DatabaseManager Tests** ([`api/tests/test_database_manager.py:126`](api/tests/test_database_manager.py:126)):\n```python\nmock_pool = AsyncMock()\nmock_pool.acquire = MagicMock(\nreturn_value=MockAsyncContextManager(mock_conn)\n)\n```\n**Scenario API Tests** ([`api/tests/test_scenario_api.py:30`](api/tests/test_scenario_api.py:30)):\n```python\n@pytest.fixture\ndef mock_feature_flag_enabled():\n\"\"\"Mock feature flag service returning enabled\"\"\"\nwith patch('api.main.feature_flag_service') as mock_ff:\nmock_ff.is_flag_enabled = AsyncMock(return_value=True)\nyield mock_ff\n```\n### 4. Async Function Mocking Problems\n**RSS Deduplicator Tests** ([`api/tests/test_rss_deduplicator.py:248`](api/tests/test_rss_deduplicator.py:248)):\n```python\n# Mock the similarity calculation to return exactly 0.8\noriginal_calc = deduplicator._calculate_similarity\nasync def mock_calc(c1, c2):\nif c1 != c2:  # Not identical\nreturn 0.8\nreturn 1.0  # Identical\ndeduplicator._calculate_similarity = mock_calc\n```\n\n## Issues Identified\n1. **Inconsistent Mock Base Classes**: Mixing `Mock` and `AsyncMock` for the same service types\n2. **Complex Mock Setup**: Overly complex mock configurations that are hard to maintain\n3. **Missing Async Specifications**: Using `Mock` instead of `AsyncMock` for async services\n4. **Manual Async Function Replacement**: Directly replacing async methods instead of proper mocking\n5. **Inconsistent Return Value Patterns**: Some mocks return values, others return AsyncMock objects\n\n## Impact\n- **Test Reliability**: Inconsistent mocking can lead to false positives/negatives\n- **Maintenance Burden**: Complex mock setups are difficult to understand and modify\n- **Performance**: Overly complex mocks can slow down test execution\n- **Framework Compatibility**: Mixed patterns may not work consistently across Python versions\n\n## Recommended Solution\n1. **Standardize AsyncMock Usage**: Use `AsyncMock` consistently for all async services\n2. **Create Mock Factory Functions**: Centralize common mock patterns\n3. **Use Proper Patch Decorators**: Replace manual method replacement with `patch` decorators\n4. **Add Type Safety**: Ensure mocks match the interface they're replacing\n5. **Document Mocking Patterns**: Create guidelines for consistent async mocking\n\n## Example Improved Pattern\n```python\n@pytest.fixture\ndef standardized_async_mock():\n\"\"\"Standardized async mock pattern\"\"\"\nmock = AsyncMock(spec=TargetService)\nmock.async_method = AsyncMock(return_value=expected_result)\nmock.sync_method = Mock(return_value=sync_result)\nreturn mock\n```\n\n## Related Files\n- `api/tests/test_websocket_manager.py`\n- `api/tests/test_scenario_service.py`\n- `api/tests/test_feature_flag_service.py`\n- `api/tests/test_scenario_validation.py`\n- `api/tests/test_database_manager.py`\n- `api/tests/test_scenario_api.py`\n- `api/tests/test_rss_deduplicator.py`" --label ""
gh issue create --repo glockpete/Forecastin --title "Service Initialization Pattern Issues and Thread Safety Concerns" --body "## Description\nService implementations exhibit inconsistent initialization patterns, thread safety concerns, and improper resource management. The codebase shows varying approaches to service startup, cleanup, and thread synchronization.\n\n## Evidence from Codebase\n### 1. Inconsistent Service Lifecycle Patterns\n**WebSocketManager** ([`api/services/websocket_manager.py:255`](api/services/websocket_manager.py:255)):\n```python\nasync def start(self) -> None:\n\"\"\"Start the WebSocket manager.\"\"\"\nif self._running:\nreturn\nself._running = True\nself._heartbeat_task = asyncio.create_task(self._heartbeat_loop())\nlogger.info(\"WebSocket manager started\")\nasync def stop(self) -> None:\n\"\"\"Stop the WebSocket manager.\"\"\"\nif not self._running:\nreturn\nself._running = False\n# Cancel heartbeat task and cleanup\n```\n**AutomatedRefreshService** ([`api/services/automated_refresh_service.py:55`](api/services/automated_refresh_service.py:55)):\n```python\ndef start_service(self):\n\"\"\"Start the automated refresh service.\"\"\"\nif self.is_running:\nlogger.warning(\"Automated refresh service is already running\")\nreturn\nself.is_running = True\nself.refresh_thread = threading.Thread(target=self._refresh_worker, daemon=True)\nself.refresh_thread.start()\nlogger.info(\"Automated refresh service started\")\n```\n**FeatureFlagService** ([`api/services/feature_flag_service.py:218`](api/services/feature_flag_service.py:218)):\n```python\nasync def initialize(self) -> None:\n\"\"\"Initialize the feature flag service.\"\"\"\nself.logger.info(\"FeatureFlagService initialized\")\nasync def cleanup(self) -> None:\n\"\"\"Cleanup the feature flag service.\"\"\"\n# Clear any pending callbacks or connections\nwith self._lock:\nself._change_callbacks.clear()\nself.logger.info(\"FeatureFlagService cleanup completed\")\n```\n### 2. Thread Safety Pattern Inconsistencies\n**HierarchicalForecastManager** ([`api/services/hierarchical_forecast_service.py:222`](api/services/hierarchical_forecast_service.py:222)):\n```python\n# Use RLock for thread safety\nself._lock = threading.RLock()\n```\n**ProphetModelCache** ([`api/services/hierarchical_forecast_service.py:124`](api/services/hierarchical_forecast_service.py:124)):\n```python\nself._lock = threading.RLock()  # RLock for re-entrant locking\n```\n**AutomatedRefreshService** ([`api/services/automated_refresh_service.py:38`](api/services/automated_refresh_service.py:38)):\n```python\nself.refresh_lock = threading.RLock()  # Using RLock as per AGENTS.md requirements\n```\n**FeatureFlagService** ([`api/services/feature_flag_service.py:210`](api/services/feature_flag_service.py:210)):\n```python\n# Use RLock for thread safety as specified\nself._lock = threading.RLock()\n```\n### 3. Resource Management Issues\n**AutomatedRefreshService Background Thread** ([`api/services/automated_refresh_service.py:73`](api/services/automated_refresh_service.py:73)):\n```python\ndef _refresh_worker(self):\n\"\"\"Background worker that periodically checks for refresh needs.\"\"\"\nwhile self.is_running:\ntry:\n# Check feature flag status\nself._update_configuration()\n# ... processing logic\ntime.sleep(30)  # Check every 30 seconds\nexcept Exception as e:\nlogger.error(f\"Error in refresh worker: {e}\")\ntime.sleep(60)  # Sleep longer on error\n```\n**Global Service Instance Pattern** ([`api/services/automated_refresh_service.py:380`](api/services/automated_refresh_service.py:380)):\n```python\n_automated_refresh_service: Optional[AutomatedRefreshService] = None\ndef get_automated_refresh_service() -> AutomatedRefreshService:\n\"\"\"Get the global automated refresh service instance.\"\"\"\nglobal _automated_refresh_service\nif _automated_refresh_service is None:\nraise RuntimeError(\"Automated refresh service not initialized\")\nreturn _automated_refresh_service\n```\n\n## Issues Identified\n1. **Mixed Lifecycle Patterns**: Some services use `start()`/`stop()`, others use `initialize()`/`cleanup()`\n2. **Inconsistent Threading Models**: Mixing `asyncio` tasks with `threading.Thread`\n3. **Global State Management**: Global service instances without proper singleton patterns\n4. **Resource Cleanup Gaps**: Missing proper cleanup in some service implementations\n5. **Error Handling Inconsistencies**: Varying approaches to exception handling in background workers\n\n## Impact\n- **Resource Leaks**: Improper cleanup can lead to memory leaks and resource exhaustion\n- **Thread Safety Risks**: Inconsistent locking patterns can cause race conditions\n- **Service Reliability**: Mixed lifecycle patterns make service management unpredictable\n- **Maintenance Complexity**: Different patterns increase cognitive load for developers\n\n## Recommended Solution\n1. **Standardize Lifecycle Interface**: Define consistent `start()`/`stop()` or `initialize()`/`cleanup()` patterns\n2. **Use Async Context Managers**: Implement `__aenter__`/`__aexit__` for resource management\n3. **Create Service Base Class**: Define common patterns for all services\n4. **Improve Error Handling**: Standardize exception handling in background workers\n5. **Use Dependency Injection**: Replace global instances with proper DI patterns\n\n## Example Improved Pattern\n```python\nclass BaseService:\n\"\"\"Standardized service base class with consistent lifecycle.\"\"\"\nasync def start(self) -> None:\n\"\"\"Start the service.\"\"\"\nif self._running:\nreturn\nself._running = True\n# Standardized startup logic\nasync def stop(self) -> None:\n\"\"\"Stop the service with proper cleanup.\"\"\"\nif not self._running:\nreturn\nself._running = False\n# Standardized cleanup logic\nasync def __aenter__(self):\nawait self.start()\nreturn self\nasync def __aexit__(self, exc_type, exc_val, exc_tb):\nawait self.stop()\n```\n\n## Related Files\n- `api/services/websocket_manager.py`\n- `api/services/automated_refresh_service.py`\n- `api/services/feature_flag_service.py`\n- `api/services/hierarchical_forecast_service.py`\n- `api/services/scenario_service.py`" --label ""