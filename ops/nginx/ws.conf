# WebSocket Proxy Configuration for Nginx
#
# This configuration demonstrates proper WebSocket proxying to prevent
# close code 1006 (abnormal closure) and ensure reliable connections.
#
# Usage:
# 1. Include this file in your nginx server block:
#    include /path/to/ops/nginx/ws.conf;
#
# 2. Or copy the location blocks into your existing nginx.conf
#
# 3. Adjust upstream backend address as needed (default: backend:9000)
#
# Key Features:
# - Proper WebSocket Upgrade headers
# - Generous timeouts to prevent idle disconnects
# - Client information forwarding (X-Forwarded-*)
# - Disabled buffering for real-time updates
# - Support for both ws:// and wss:// (SSL)

# Upstream backend server (adjust host/port as needed)
upstream fastapi_backend {
    server backend:9000;
    # For localhost testing: server localhost:9000;
    # For production: server api.example.com:9000;

    # Optional: keepalive connections
    keepalive 32;
}

# WebSocket endpoints
# Location: /ws (primary WebSocket)
location /ws {
    proxy_pass http://fastapi_backend;

    # ========================================
    # CRITICAL: WebSocket upgrade headers
    # ========================================
    # Without these, connections fail with 1006 or 400 Bad Request
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # ========================================
    # Client information headers
    # ========================================
    # These help server diagnostics identify connection source and scheme
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;  # ws or wss
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # ========================================
    # CRITICAL: Timeout configuration
    # ========================================
    # Prevent 1006 errors from idle timeout disconnects
    # Set higher than server WS_PING_INTERVAL (default 30s)
    proxy_read_timeout 300s;      # 5 minutes - generous for long-lived connections
    proxy_connect_timeout 10s;    # Connection establishment timeout
    proxy_send_timeout 30s;       # Timeout for sending data to backend

    # ========================================
    # Performance tuning
    # ========================================
    # Disable buffering for real-time WebSocket messages
    proxy_buffering off;

    # Optional: Increase buffer sizes for large messages
    # proxy_buffer_size 4k;
    # proxy_buffers 8 4k;

    # Optional: Cache WebSocket-compatible
    # proxy_cache off;
}

# Location: /ws/echo (diagnostic echo endpoint)
location /ws/echo {
    proxy_pass http://fastapi_backend;

    # Same WebSocket configuration as /ws
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;

    proxy_read_timeout 300s;
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;

    proxy_buffering off;
}

# Location: /ws/health (health monitoring endpoint)
location /ws/health {
    proxy_pass http://fastapi_backend;

    # Same WebSocket configuration
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;

    proxy_read_timeout 300s;
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;

    proxy_buffering off;
}

# ========================================
# SSL/TLS Configuration (for wss://)
# ========================================
# If terminating SSL at nginx, ensure proper configuration:
#
# server {
#     listen 443 ssl http2;
#     server_name yourdomain.com;
#
#     ssl_certificate /path/to/cert.pem;
#     ssl_certificate_key /path/to/key.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#
#     # Include WebSocket locations
#     include /path/to/ops/nginx/ws.conf;
# }

# ========================================
# Troubleshooting
# ========================================
#
# 1. Test WebSocket upgrade response:
#    curl -i -N \
#      -H "Connection: Upgrade" \
#      -H "Upgrade: websocket" \
#      http://localhost/ws/health
#
#    Expected:
#    HTTP/1.1 101 Switching Protocols
#    Upgrade: websocket
#    Connection: upgrade
#
# 2. Check nginx error logs:
#    tail -f /var/log/nginx/error.log
#
# 3. Verify backend is reachable:
#    curl http://backend:9000/health
#
# 4. Common issues:
#    - 502 Bad Gateway: Backend not running or unreachable
#    - 400 Bad Request: Missing Upgrade headers
#    - 1006 after 60s: proxy_read_timeout too low
#    - Mixed content: Using ws:// on HTTPS site (use wss://)
#
# 5. Enable debug logging (temporary):
#    error_log /var/log/nginx/error.log debug;
#
# For detailed diagnostics, see: checks/ws_server_diagnostics.md
